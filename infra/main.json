{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "13447627002521738017"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "appName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 20,
      "metadata": {
        "description": "Base name for the application"
      }
    },
    "environmentType": {
      "type": "string",
      "defaultValue": "Starter",
      "allowedValues": [
        "Starter",
        "Enterprise"
      ],
      "metadata": {
        "description": "Environment type"
      }
    },
    "containerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image to deploy"
      }
    },
    "databaseAdminLogin": {
      "type": "string",
      "defaultValue": "dbadmin",
      "metadata": {
        "description": "Database administrator login"
      }
    },
    "databaseAdminPassword": {
      "type": "securestring",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Database administrator password"
      }
    },
    "adminApiKey": {
      "type": "securestring",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Admin API key for management endpoints"
      }
    },
    "databaseName": {
      "type": "string",
      "defaultValue": "fabricmon",
      "metadata": {
        "description": "Database name"
      }
    },
    "ownerName": {
      "type": "string",
      "defaultValue": "Yari Bouwman",
      "metadata": {
        "description": "Owner name for tagging"
      }
    },
    "costCenter": {
      "type": "string",
      "defaultValue": "Engineering",
      "metadata": {
        "description": "Cost center for tagging"
      }
    },
    "alertEmails": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Email addresses for alert notifications (comma-separated, e.g. a@example.com,b@example.com)"
      }
    }
  },
  "variables": {
    "alertEmailsArray": "[if(empty(parameters('alertEmails')), createArray(), split(parameters('alertEmails'), ','))]",
    "nameSuffix": "[uniqueString(resourceGroup().id)]",
    "tags": {
      "Owner": "[parameters('ownerName')]",
      "Environment": "[parameters('environmentType')]",
      "CostCenter": "[parameters('costCenter')]",
      "Project": "Fabric Capacity Monitor"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "identity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "identityName": {
            "value": "[format('id-{0}-{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "11392507144089567668"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for the identity"
              }
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name of the user assigned managed identity"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').clientId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[format('vnet-{0}-{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "namePrefix": {
            "value": "[parameters('appName')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "7376374129576254137"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for network resources"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the virtual network"
              }
            },
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "Name prefix for subnets and NSGs"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "vnetAddressPrefix": "10.0.0.0/16",
            "appSubnetAddressPrefix": "10.0.0.0/23",
            "dbSubnetAddressPrefix": "10.0.2.0/24",
            "privateEndpointSubnetAddressPrefix": "10.0.3.0/24"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-nsg-app', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAzureLoadBalancer",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-nsg-db', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAppSubnet",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "5432",
                      "sourceAddressPrefix": "[variables('appSubnetAddressPrefix')]",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-nsg-pe', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": []
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-11-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[variables('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[format('{0}-snet-app', parameters('namePrefix'))]",
                    "properties": {
                      "addressPrefix": "[variables('appSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg-app', parameters('namePrefix')))]"
                      },
                      "delegations": [
                        {
                          "name": "Microsoft.App.environments",
                          "properties": {
                            "serviceName": "Microsoft.App/environments"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "[format('{0}-snet-db', parameters('namePrefix'))]",
                    "properties": {
                      "addressPrefix": "[variables('dbSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg-db', parameters('namePrefix')))]"
                      },
                      "delegations": [
                        {
                          "name": "Microsoft.DBforPostgreSQL.flexibleServers",
                          "properties": {
                            "serviceName": "Microsoft.DBforPostgreSQL/flexibleServers"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "[format('{0}-snet-pe', parameters('namePrefix'))]",
                    "properties": {
                      "addressPrefix": "[variables('privateEndpointSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg-pe', parameters('namePrefix')))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg-app', parameters('namePrefix')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg-db', parameters('namePrefix')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg-pe', parameters('namePrefix')))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the virtual network"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "appSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the app subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-11-01').subnets[0].id]"
            },
            "dbSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the database subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-11-01').subnets[1].id]"
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the private endpoint subnet"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-11-01').subnets[2].id]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the virtual network"
              },
              "value": "[parameters('vnetName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "database-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "serverName": {
            "value": "[format('psql-{0}-{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "administratorLogin": {
            "value": "[parameters('databaseAdminLogin')]"
          },
          "administratorLoginPassword": {
            "value": "[parameters('databaseAdminPassword')]"
          },
          "databaseName": {
            "value": "[parameters('databaseName')]"
          },
          "environmentType": {
            "value": "[parameters('environmentType')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.dbSubnetId.value]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17387917886152747647"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for database resources"
              }
            },
            "serverName": {
              "type": "string",
              "metadata": {
                "description": "Name of the PostgreSQL server"
              }
            },
            "administratorLogin": {
              "type": "string",
              "metadata": {
                "description": "Administrator login username"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Administrator login password"
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Database name"
              }
            },
            "environmentType": {
              "type": "string",
              "allowedValues": [
                "Starter",
                "Enterprise"
              ],
              "metadata": {
                "description": "Environment type for SKU selection"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the database subnet"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the virtual network"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "skuConfig": {
              "Starter": {
                "name": "Standard_B1ms",
                "tier": "Burstable",
                "storageSizeGB": 32,
                "backupRetentionDays": 7,
                "geoRedundantBackup": "Disabled",
                "highAvailability": "Disabled"
              },
              "Enterprise": {
                "name": "Standard_D2s_v3",
                "tier": "GeneralPurpose",
                "storageSizeGB": 128,
                "backupRetentionDays": 35,
                "geoRedundantBackup": "Enabled",
                "highAvailability": "ZoneRedundant"
              }
            },
            "sku": "[variables('skuConfig')[parameters('environmentType')]]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.postgres.database.azure.com",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.postgres.database.azure.com', format('{0}-link', parameters('serverName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.postgres.database.azure.com')]"
              ]
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2023-03-01-preview",
              "name": "[parameters('serverName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[variables('sku').name]",
                "tier": "[variables('sku').tier]"
              },
              "properties": {
                "version": "16",
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "storage": {
                  "storageSizeGB": "[variables('sku').storageSizeGB]"
                },
                "backup": {
                  "backupRetentionDays": "[variables('sku').backupRetentionDays]",
                  "geoRedundantBackup": "[variables('sku').geoRedundantBackup]"
                },
                "highAvailability": {
                  "mode": "[variables('sku').highAvailability]"
                },
                "network": {
                  "delegatedSubnetResourceId": "[parameters('subnetId')]",
                  "privateDnsZoneArmResourceId": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.postgres.database.azure.com')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.postgres.database.azure.com')]",
                "[resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', 'privatelink.postgres.database.azure.com', format('{0}-link', parameters('serverName')))]"
              ]
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
              "apiVersion": "2023-03-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), parameters('databaseName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('serverName'))]"
              ]
            }
          ],
          "outputs": {
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Fully qualified domain name of the PostgreSQL server"
              },
              "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('serverName')), '2023-03-01-preview').fullyQualifiedDomainName]"
            },
            "serverName": {
              "type": "string",
              "metadata": {
                "description": "Name of the PostgreSQL server"
              },
              "value": "[parameters('serverName')]"
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Name of the database"
              },
              "value": "[parameters('databaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "registry-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "registryName": {
            "value": "[format('acr{0}{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "14378331638852167856"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Container Registry"
              }
            },
            "registryName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Registry"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity to grant AcrPull access"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('registryName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "adminUserEnabled": false,
                "publicNetworkAccess": "Enabled",
                "zoneRedundancy": "Disabled"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), parameters('managedIdentityPrincipalId'), 'AcrPull')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName'))]"
              ]
            }
          ],
          "outputs": {
            "registryName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Registry"
              },
              "value": "[parameters('registryName')]"
            },
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "Login server of the Container Registry"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), '2023-07-01').loginServer]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "storageAccountName": {
            "value": "[format('st{0}{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "6428167175388653234"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for storage account"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity to grant access"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('managedIdentityPrincipalId'), 'Storage Blob Data Contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[parameters('storageAccountName')]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Storage account connection string"
              },
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "keyVaultName": {
            "value": "[format('kv-{0}-{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "databaseConnectionString": {
            "value": "[format('postgresql://{0}:{1}@{2}:5432/{3}?sslmode=require', parameters('databaseAdminLogin'), parameters('databaseAdminPassword'), reference(resourceId('Microsoft.Resources/deployments', 'database-deployment'), '2025-04-01').outputs.fqdn.value, parameters('databaseName'))]"
          },
          "adminApiKey": {
            "value": "[parameters('adminApiKey')]"
          },
          "environmentType": {
            "value": "[parameters('environmentType')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17550649830410798082"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Key Vault"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity to grant access"
              }
            },
            "databaseConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Database connection string to store"
              }
            },
            "adminApiKey": {
              "type": "securestring",
              "metadata": {
                "description": "Admin API key to store"
              }
            },
            "environmentType": {
              "type": "string",
              "defaultValue": "Starter",
              "allowedValues": [
                "Starter",
                "Enterprise"
              ],
              "metadata": {
                "description": "Environment type: Starter or Enterprise"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Private endpoint subnet ID for Enterprise tier"
              }
            },
            "vnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "VNet ID for private DNS zone link"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": "[if(equals(parameters('environmentType'), 'Enterprise'), 90, 7)]",
                "enablePurgeProtection": "[equals(parameters('environmentType'), 'Enterprise')]",
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": false,
                "publicNetworkAccess": "[if(equals(parameters('environmentType'), 'Enterprise'), 'Disabled', 'Enabled')]",
                "networkAcls": "[if(equals(parameters('environmentType'), 'Starter'), createObject('bypass', 'AzureServices', 'defaultAction', 'Allow'), createObject('bypass', 'AzureServices', 'defaultAction', 'Deny'))]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('managedIdentityPrincipalId'), 'Key Vault Secrets User')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'db-connection-string')]",
              "properties": {
                "value": "[parameters('databaseConnectionString')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'admin-api-key')]",
              "properties": {
                "value": "[parameters('adminApiKey')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "condition": "[equals(parameters('environmentType'), 'Enterprise')]",
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.vaultcore.azure.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[equals(parameters('environmentType'), 'Enterprise')]",
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.vaultcore.azure.net', format('{0}-link', parameters('keyVaultName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
              ]
            },
            {
              "condition": "[equals(parameters('environmentType'), 'Enterprise')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-pe', parameters('keyVaultName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('keyVaultName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "condition": "[equals(parameters('environmentType'), 'Enterprise')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('keyVaultName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]",
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('keyVaultName')))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              },
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the Key Vault"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "databaseConnectionStringSecretUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the database connection string secret"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), 'db-connection-string'), '2023-07-01').secretUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'database-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerapp-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[format('cae-{0}-{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "appName": {
            "value": "[format('ca-{0}-{1}', parameters('appName'), variables('nameSuffix'))]"
          },
          "environmentType": {
            "value": "[parameters('environmentType')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.appSubnetId.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "containerImage": {
            "value": "[parameters('containerImage')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "storageConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.connectionString.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "9115035821742477070"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Container Apps"
              }
            },
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps Environment"
              }
            },
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "environmentType": {
              "type": "string",
              "allowedValues": [
                "Starter",
                "Enterprise"
              ],
              "metadata": {
                "description": "Environment type for scaling configuration"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the app subnet"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the user assigned managed identity"
              }
            },
            "containerImage": {
              "type": "string",
              "metadata": {
                "description": "Container image to deploy"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name for secret references"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Storage connection string for distributed locking"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "scaleConfig": {
              "Starter": {
                "minReplicas": 0,
                "maxReplicas": 3,
                "cpu": "0.5",
                "memory": "1Gi"
              },
              "Enterprise": {
                "minReplicas": 1,
                "maxReplicas": 10,
                "cpu": "2.0",
                "memory": "4Gi"
              }
            },
            "scale": "[variables('scaleConfig')[parameters('environmentType')]]"
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('environmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "vnetConfiguration": {
                  "infrastructureSubnetId": "[parameters('subnetId')]"
                },
                "workloadProfiles": [
                  {
                    "name": "Consumption",
                    "workloadProfileType": "Consumption"
                  }
                ],
                "zoneRedundant": "[equals(parameters('environmentType'), 'Enterprise')]"
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('appName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "environmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]",
                "workloadProfileName": "Consumption",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 8000,
                    "transport": "http",
                    "allowInsecure": false
                  },
                  "secrets": [
                    {
                      "name": "db-connection-string",
                      "keyVaultUrl": "[format('https://{0}.vault.azure.net/secrets/db-connection-string', parameters('keyVaultName'))]",
                      "identity": "[parameters('managedIdentityId')]"
                    },
                    {
                      "name": "admin-api-key",
                      "keyVaultUrl": "[format('https://{0}.vault.azure.net/secrets/admin-api-key', parameters('keyVaultName'))]",
                      "identity": "[parameters('managedIdentityId')]"
                    },
                    {
                      "name": "storage-connection-string",
                      "value": "[parameters('storageConnectionString')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "main",
                      "image": "[parameters('containerImage')]",
                      "resources": {
                        "cpu": "[json(variables('scale').cpu)]",
                        "memory": "[variables('scale').memory]"
                      },
                      "env": [
                        {
                          "name": "DATABASE_URL",
                          "secretRef": "db-connection-string"
                        },
                        {
                          "name": "ADMIN_API_KEY",
                          "secretRef": "admin-api-key"
                        },
                        {
                          "name": "AZURE_STORAGE_CONNECTION_STRING",
                          "secretRef": "storage-connection-string"
                        },
                        {
                          "name": "AZURE_KEY_VAULT_URL",
                          "value": "[format('https://{0}.vault.azure.net', parameters('keyVaultName'))]"
                        },
                        {
                          "name": "COLLECTOR_INTERVAL_MINUTES",
                          "value": "15"
                        },
                        {
                          "name": "COLLECTOR_MAX_CONCURRENCY",
                          "value": "10"
                        },
                        {
                          "name": "LOG_LEVEL",
                          "value": "INFO"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[variables('scale').minReplicas]",
                    "maxReplicas": "[variables('scale').maxReplicas]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
              ]
            }
          ],
          "outputs": {
            "appFqdn": {
              "type": "string",
              "metadata": {
                "description": "Fully qualified domain name of the Container App"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('appName')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              },
              "value": "[parameters('appName')]"
            },
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps Environment"
              },
              "value": "[parameters('environmentName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultId": {
            "value": "[resourceId('Microsoft.KeyVault/vaults', reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value)]"
          },
          "containerAppId": {
            "value": "[resourceId('Microsoft.App/containerApps', reference(resourceId('Microsoft.Resources/deployments', 'containerapp-deployment'), '2025-04-01').outputs.appName.value)]"
          },
          "alertEmails": {
            "value": "[variables('alertEmailsArray')]"
          },
          "environmentType": {
            "value": "[parameters('environmentType')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "4277101662566282276"
            }
          },
          "parameters": {
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Key Vault"
              }
            },
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Container App"
              }
            },
            "alertEmails": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Action group email addresses for alerts"
              }
            },
            "environmentType": {
              "type": "string",
              "defaultValue": "Starter",
              "allowedValues": [
                "Starter",
                "Enterprise"
              ],
              "metadata": {
                "description": "Environment type"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "condition": "[greater(length(parameters('alertEmails')), 0)]",
              "type": "Microsoft.Insights/actionGroups",
              "apiVersion": "2023-01-01",
              "name": "ag-fabricmon-alerts",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "emailReceivers",
                    "count": "[length(parameters('alertEmails'))]",
                    "input": {
                      "name": "[format('email-{0}', copyIndex('emailReceivers'))]",
                      "emailAddress": "[parameters('alertEmails')[copyIndex('emailReceivers')]]",
                      "useCommonAlertSchema": true
                    }
                  }
                ],
                "groupShortName": "FabricMon",
                "enabled": true
              }
            },
            {
              "condition": "[greater(length(parameters('alertEmails')), 0)]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "alert-keyvault-failed-requests",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "Alert when Key Vault has failed authentication requests (potential breach or misconfiguration)",
                "severity": 1,
                "enabled": true,
                "scopes": [
                  "[parameters('keyVaultId')]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT5M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "FailedRequests",
                      "criterionType": "StaticThresholdCriterion",
                      "metricName": "ServiceApiResult",
                      "metricNamespace": "Microsoft.KeyVault/vaults",
                      "operator": "GreaterThan",
                      "threshold": 10,
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "StatusCode",
                          "operator": "Include",
                          "values": [
                            "401",
                            "403"
                          ]
                        }
                      ]
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
              ]
            },
            {
              "condition": "[greater(length(parameters('alertEmails')), 0)]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "alert-keyvault-availability",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "Alert when Key Vault availability drops below 99.9%",
                "severity": 2,
                "enabled": true,
                "scopes": [
                  "[parameters('keyVaultId')]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "Availability",
                      "criterionType": "StaticThresholdCriterion",
                      "metricName": "Availability",
                      "metricNamespace": "Microsoft.KeyVault/vaults",
                      "operator": "LessThan",
                      "threshold": 99,
                      "timeAggregation": "Average"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
              ]
            },
            {
              "condition": "[and(greater(length(parameters('alertEmails')), 0), equals(parameters('environmentType'), 'Enterprise'))]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "alert-containerapp-high-cpu",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "Alert when Container App CPU usage exceeds 80%",
                "severity": 2,
                "enabled": true,
                "scopes": [
                  "[parameters('containerAppId')]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "CpuUsage",
                      "criterionType": "StaticThresholdCriterion",
                      "metricName": "UsageNanoCores",
                      "metricNamespace": "Microsoft.App/containerApps",
                      "operator": "GreaterThan",
                      "threshold": 1600000000,
                      "timeAggregation": "Average"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
              ]
            },
            {
              "condition": "[and(greater(length(parameters('alertEmails')), 0), equals(parameters('environmentType'), 'Enterprise'))]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "alert-containerapp-high-memory",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "Alert when Container App memory usage exceeds 80%",
                "severity": 2,
                "enabled": true,
                "scopes": [
                  "[parameters('containerAppId')]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "MemoryUsage",
                      "criterionType": "StaticThresholdCriterion",
                      "metricName": "WorkingSetBytes",
                      "metricNamespace": "Microsoft.App/containerApps",
                      "operator": "GreaterThan",
                      "threshold": 3355443200,
                      "timeAggregation": "Average"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts')]"
              ]
            }
          ],
          "outputs": {
            "actionGroupId": {
              "type": "string",
              "metadata": {
                "description": "Action Group ID"
              },
              "value": "[if(greater(length(parameters('alertEmails')), 0), resourceId('Microsoft.Insights/actionGroups', 'ag-fabricmon-alerts'), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'containerapp-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]"
      ]
    }
  ],
  "outputs": {
    "appUrl": {
      "type": "string",
      "metadata": {
        "description": "Container App URL"
      },
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'containerapp-deployment'), '2025-04-01').outputs.appFqdn.value)]"
    },
    "registryLoginServer": {
      "type": "string",
      "metadata": {
        "description": "Container Registry login server"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'registry-deployment'), '2025-04-01').outputs.loginServer.value]"
    },
    "registryName": {
      "type": "string",
      "metadata": {
        "description": "Container Registry name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'registry-deployment'), '2025-04-01').outputs.registryName.value]"
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage account name for distributed locking"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
    }
  }
}